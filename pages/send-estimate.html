<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Комфорт Сервис Плюс - Отправка сметы</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="../css/styles.css">
  <style>
    .send-container {
      background-color: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
    }
    
    .form-control {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 16px;
    }
    
    textarea.form-control {
      min-height: 100px;
      resize: vertical;
    }
    
    .send-options {
      margin-bottom: 20px;
    }
    
    .option-title {
      font-weight: 600;
      margin-bottom: 15px;
    }
    
    .option-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
    }
    
    .option-card {
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 15px;
      text-align: center;
      cursor: pointer;
    }
    
    .option-card.active {
      border-color: var(--primary-color);
      background-color: #e8f4ff;
    }
    
    .option-icon {
      font-size: 24px;
      margin-bottom: 10px;
      color: var(--primary-color);
    }
    
    .estimate-preview {
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 15px;
      margin-bottom: 20px;
      background-color: #f8f9fa;
    }
    
    .preview-title {
      font-weight: 600;
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .preview-actions {
      display: flex;
      gap: 10px;
    }
    
    .preview-action {
      background-color: var(--secondary-color);
      color: var(--text-color);
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
    }
    
    .preview-action i {
      margin-right: 5px;
    }
    
    .status-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
      margin-top: 15px;
    }
    
    .status-scheduled {
      background-color: #e8f5e9;
      color: #388e3c;
    }
    
    .loading-container {
      text-align: center;
      padding: 50px 0;
    }
    
    .loading-spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top: 4px solid var(--accent-color);
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <a href="client-details.html" class="back-button" id="backLink">
        <span class="back-icon">←</span> <span id="clientName">Назад</span>
      </a>
      <h2>Отправка сметы</h2>
      <button class="menu-button" onclick="toggleMenu()">☰</button>
    </div>
    
    <!-- Loading indicator -->
    <div id="loadingContainer" class="loading-container">
      <div class="loading-spinner"></div>
      <p>Загрузка данных клиента...</p>
    </div>
    
    <!-- Main content (hidden initially) -->
    <div id="mainContainer" style="display: none;">
      <div class="estimate-preview">
        <div class="preview-title">
          <div>Предпросмотр сметы:</div>
          <div class="preview-actions">
            <button class="preview-action" onclick="window.open('estimate-preview.html?clientId=' + clientId, '_blank')">
              <i class="fas fa-eye"></i> Просмотр
            </button>
            <button class="preview-action" onclick="printEstimate()">
              <i class="fas fa-print"></i> Печать
            </button>
          </div>
        </div>
        
        <div id="estimateSummary">
          <p><strong>Клиент:</strong> <span id="summaryClientName">Качан Д.Ю.</span></p>
          <p><strong>Общая площадь:</strong> <span id="summaryArea">2.64 м²</span></p>
          <p><strong>Материал:</strong> <span id="summaryMaterial">Silver 15</span></p>
          <p><strong>Стоимость:</strong> <span id="summaryTotal">2,163₴</span></p>
        </div>
      </div>
      
      <div class="send-container">
        <div class="send-options">
          <div class="option-title">Выберите способ отправки:</div>
          
          <div class="option-grid">
            <div class="option-card active" data-method="email" onclick="selectSendMethod(this)">
              <div class="option-icon"><i class="fas fa-envelope"></i></div>
              <div>По Email</div>
            </div>
            
            <div class="option-card" data-method="viber" onclick="selectSendMethod(this)">
              <div class="option-icon"><i class="fab fa-viber"></i></div>
              <div>Viber</div>
            </div>
            
            <div class="option-card" data-method="telegram" onclick="selectSendMethod(this)">
              <div class="option-icon"><i class="fab fa-telegram"></i></div>
              <div>Telegram</div>
            </div>
            
            <div class="option-card" data-method="whatsapp" onclick="selectSendMethod(this)">
              <div class="option-icon"><i class="fab fa-whatsapp"></i></div>
              <div>WhatsApp</div>
            </div>
          </div>
        </div>
        
        <form id="sendForm">
          <div class="form-group">
            <label for="recipient" class="form-label">Email получателя:</label>
            <input type="email" id="recipient" class="form-control" required>
          </div>
          
          <div class="form-group">
            <label for="subject" class="form-label">Тема сообщения:</label>
            <input type="text" id="subject" class="form-control" value="Смета на установку бронепленки">
          </div>
          
          <div class="form-group">
            <label for="message" class="form-label">Сообщение:</label>
            <textarea id="message" class="form-control">Добрый день!

Направляем Вам смету на установку бронепленки согласно Вашего запроса.
Для уточнения деталей или согласования даты установки, пожалуйста, свяжитесь с нами.

С уважением,
Команда Комфорт Сервис Плюс</textarea>
          </div>
          
          <button type="submit" class="btn btn-primary btn-block">
            <i class="fas fa-paper-plane"></i> Отправить смету
          </button>
        </form>
      </div>
      
      <div id="statusContainer" style="display: none; text-align: center;">
        <div class="status-badge status-scheduled">
          Смета успешно отправлена
        </div>
      </div>
    </div>
  </div>
  
  <!-- Include side menu component -->
  <div id="sideMenuContainer"></div>
  
  <!-- Firebase SDK v9 with CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="../js/main.js"></script>
  
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAGGpNFxQ1bfY4ViSdNM7uOBuk7u_cyxtk",
      authDomain: "ksplus-60132.firebaseapp.com",
      projectId: "ksplus-60132",
      storageBucket: "ksplus-60132.firebasestorage.app",
      messagingSenderId: "1037863910173",
      appId: "1:1037863910173:web:76bebcb7310eaa78a23ff4",
      measurementId: "G-17JRYGSH0S"
    };
    
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    
    // Get Firestore reference
    const db = firebase.firestore();
    
    // Global client ID
    let clientId = '';
    
    document.addEventListener('DOMContentLoaded', function() {
      // Load the side menu component
      fetch('../components/sidebar.html')
        .then(response => response.text())
        .then(html => {
          document.getElementById('sideMenuContainer').innerHTML = html;
          
          // Execute any scripts inside the loaded sidebar
          const scripts = document.getElementById('sideMenuContainer').getElementsByTagName('script');
          for (let i = 0; i < scripts.length; i++) {
            eval(scripts[i].innerText);
          }
        });
      
      // Check authentication status
      firebase.auth().onAuthStateChanged(function(user) {
        if (user) {
          // Get client ID from URL
          const urlParams = new URLSearchParams(window.location.search);
          clientId = urlParams.get('clientId');
          
          if (clientId) {
            // Load client data
            loadClientData(clientId);
            
            // Update back link
            document.getElementById('backLink').href = `client-details.html?id=${clientId}`;
          } else {
            // No client ID, redirect to clients list
            window.location.href = 'clients.html';
          }
        } else {
          // User is signed out, redirect to login
          window.location.href = 'login.html';
        }
      });
      
      // Set up send form submission
      document.getElementById('sendForm').addEventListener('submit', function(e) {
        e.preventDefault();
        sendEstimate();
      });
    });
    
    // Load client data
    async function loadClientData(clientId) {
      try {
        const docRef = db.collection('clients').doc(clientId);
        const docSnap = await docRef.get();
        
        if (docSnap.exists) {
          const client = {
            id: docSnap.id,
            ...docSnap.data()
          };
          
          // Display client name in header
          document.getElementById('clientName').textContent = client.name || 'Клиент';
          
          // Set email in form if available
          if (client.email) {
            document.getElementById('recipient').value = client.email;
          } else if (client.phone) {
            // Use phone if email not available
            document.getElementById('recipient').value = client.phone + '@sms.example.com';
          }
          
          // Update summary
          document.getElementById('summaryClientName').textContent = client.name || 'Не указано';
          
          // TODO: Load real estimate data from database in a real app
          // For demo, we'll use placeholder data
          document.getElementById('summaryArea').textContent = '2.64 м²';
          document.getElementById('summaryMaterial').textContent = 'Silver 15';
          document.getElementById('summaryTotal').textContent = '2,163₴';
          
          // Show main container and hide loading
          document.getElementById('loadingContainer').style.display = 'none';
          document.getElementById('mainContainer').style.display = 'block';
        } else {
          throw new Error("Client not found");
        }
      } catch (error) {
        console.error("Error loading client data:", error);
        alert("Не удалось загрузить данные клиента");
        window.location.href = 'clients.html';
      }
    }
    
    // Select send method
    function selectSendMethod(element) {
      // Remove active class from all options
      document.querySelectorAll('.option-card').forEach(card => {
        card.classList.remove('active');
      });
      
      // Add active class to selected option
      element.classList.add('active');
      
      // Update form based on selected method
      const method = element.getAttribute('data-method');
      const recipientLabel = document.querySelector('label[for="recipient"]');
      const recipientInput = document.getElementById('recipient');
      
      switch (method) {
        case 'email':
          recipientLabel.textContent = 'Email получателя:';
          recipientInput.type = 'email';
          break;
        case 'viber':
        case 'whatsapp':
        case 'telegram':
          recipientLabel.textContent = 'Номер телефона:';
          recipientInput.type = 'tel';
          break;
      }
    }
    
    // Send estimate
    async function sendEstimate() {
      const method = document.querySelector('.option-card.active').getAttribute('data-method');
      const recipient = document.getElementById('recipient').value;
      const subject = document.getElementById('subject').value;
      const message = document.getElementById('message').value;
      
      // In a real app, this would send the message via API
      // For demo purposes, we'll just simulate sending
      
      try {
        // Update client status in database
        await db.collection('clients').doc(clientId).update({
          status: 'Смета отправлена',
          lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Show success message
        document.getElementById('statusContainer').style.display = 'block';
        document.getElementById('sendForm').style.display = 'none';
        
        // Log the "sent" message details
        console.log(`Смета отправлена через ${method} на адрес ${recipient}`);
        console.log(`Тема: ${subject}`);
        console.log(`Сообщение: ${message}`);
        
        // Redirect back to client after a delay
        setTimeout(() => {
          window.location.href = `client-details.html?id=${clientId}`;
        }, 3000);
      } catch (error) {
        console.error("Error sending estimate:", error);
        alert("Произошла ошибка при отправке сметы. Пожалуйста, попробуйте снова.");
      }
    }
    
    // Print estimate
    function printEstimate() {
      window.open(`estimate-preview.html?clientId=${clientId}&print=true`, '_blank');
    }
  </script>
</body>
</html> 