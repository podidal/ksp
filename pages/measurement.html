<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ö–æ–º—Ñ–æ—Ä—Ç –°–µ—Ä–≤–∏—Å –ü–ª—é—Å - –ó–∞–º–µ—Ä –æ–∫–æ–Ω</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="../css/styles.css">
  <style>
    .manual-input {
      margin-bottom: 20px;
    }
    
    .manual-input-title {
      font-weight: 600;
      margin-bottom: 10px;
    }
    
    .manual-input-form {
      display: flex;
      align-items: center;
    }
    
    .manual-input-field {
      width: 80px;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      margin-right: 10px;
      text-align: center;
    }
    
    .manual-input-label {
      font-size: 12px;
      text-align: center;
      margin-bottom: 5px;
    }
    
    .quick-input {
      margin-bottom: 20px;
    }
    
    .quick-input-title {
      font-weight: 600;
      margin-bottom: 10px;
    }
    
    .quick-input-area {
      width: 100%;
      height: 80px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 10px;
      font-size: 14px;
    }
    
    .items-list {
      margin-bottom: 20px;
    }
    
    .items-list-title {
      font-weight: 600;
      margin-bottom: 10px;
    }
    
    .item-card {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      margin-bottom: 10px;
      background-color: white;
    }
    
    .item-shape {
      margin-right: 10px;
      min-width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
    }

    .shape-horizontal {
      background-color: #4a6da7;
    }

    .shape-vertical {
      background-color: #28a745;
    }

    .shape-square {
      background-color: #fd7e14;
    }
    
    .item-info {
      flex-grow: 1;
    }
    
    .item-dimensions {
      font-weight: 600;
    }
    
    .item-area {
      font-size: 12px;
      color: #6c757d;
    }
    
    .item-actions {
      display: flex;
    }
    
    .item-action-btn {
      background: none;
      border: none;
      font-size: 16px;
      cursor: pointer;
      margin-left: 10px;
    }
    
    .summary {
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 15px;
      margin-bottom: 20px;
      background-color: #f8f9fa;
    }
    
    .summary-title {
      font-weight: 600;
      margin-bottom: 10px;
    }
    
    .summary-item {
      margin-bottom: 5px;
    }
    
    .cutting-map {
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 20px;
      background-color: #f8f9fa;
    }
    
    .cutting-map-visual {
      height: 20px;
      background: linear-gradient(to right, #4a6da7 85%, #f8f9fa 15%);
      border-radius: 4px;
      margin-bottom: 5px;
    }
    
    .cutting-map-info {
      font-size: 12px;
      text-align: center;
    }

    .edit-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .edit-modal-content {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      width: 80%;
      max-width: 400px;
    }

    .edit-modal-title {
      font-weight: 600;
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
    }

    .edit-modal-close {
      cursor: pointer;
      font-size: 20px;
    }

    .edit-modal-form {
      margin-bottom: 15px;
    }

    .edit-modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <a href="client-details.html" class="back-button" id="backLink">
        <span class="back-icon">‚Üê</span> <span id="clientName">–ö–∞—á–∞–Ω –î.–Æ.</span>
      </a>
      <h2>–ó–∞–º–µ—Ä –æ–∫–æ–Ω</h2>
      <button class="menu-button" onclick="toggleMenu()">‚ò∞</button>
    </div>
    
    <div class="manual-input">
      <div class="manual-input-title">üè† –†—É—á–Ω–æ–π –≤–≤–æ–¥:</div>
      <div class="manual-input-form">
        <div>
          <div class="manual-input-label">–®–∏—Ä.</div>
          <input type="number" id="width" class="manual-input-field" value="800">
        </div>
        <div>
          <div class="manual-input-label">–í—ã—Å.</div>
          <input type="number" id="height" class="manual-input-field" value="600">
        </div>
        <div>
          <div class="manual-input-label">–ö–æ–ª</div>
          <input type="number" id="quantity" class="manual-input-field" value="2">
        </div>
        <button id="addItemBtn" class="btn btn-primary">OK</button>
      </div>
    </div>
    
    <div class="quick-input">
      <div class="quick-input-title">üìù –ë—ã—Å—Ç—Ä—ã–π –≤–≤–æ–¥ (—á–µ—Ä–µ–∑ —Ç–æ—á–∫—É —Å –∑–∞–ø—è—Ç–æ–π):</div>
      <textarea id="quickInput" class="quick-input-area" placeholder="–ü—Ä–∏–º–µ—Ä: 800;600;2">800;600;2
1200;800;1
600;400;3</textarea>
    </div>
    
    <div class="items-list">
      <div class="items-list-title">üìä –°–ø–∏—Å–æ–∫ –¥–µ—Ç–∞–ª–µ–π:</div>
      <div id="itemsList">
        <!-- Items will be added here dynamically -->
      </div>
    </div>
    
    <div class="summary">
      <div class="summary-title">üìà –°–≤–æ–¥–∫–∞:</div>
      <div id="totalItems" class="summary-item">‚Ä¢ –î–µ—Ç–∞–ª–µ–π: 0</div>
      <div id="totalArea" class="summary-item">‚Ä¢ –û–±—â–∞—è –ø–ª–æ—â–∞–¥—å: 0 –º¬≤</div>
      <div id="rollLength" class="summary-item">‚Ä¢ –†—É–ª–æ–Ω: 0 –º–ø (0 –º¬≤)</div>
    </div>
    
    <div class="cutting-map">
      <div id="cuttingMapVisual" class="cutting-map-visual"></div>
      <div id="cuttingMapInfo" class="cutting-map-info">0% –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ</div>
    </div>
    
    <button class="btn btn-success btn-block" id="goToCuttingBtn">
      –ü–µ—Ä–µ–π—Ç–∏ –∫ —Ä–∞—Å–∫—Ä–æ—é
    </button>
  </div>
  
  <!-- Edit item modal -->
  <div id="editModal" class="edit-modal">
    <div class="edit-modal-content">
      <div class="edit-modal-title">
        <span>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ—Ç–∞–ª–∏</span>
        <span class="edit-modal-close" onclick="closeEditModal()">&times;</span>
      </div>
      <div class="edit-modal-form">
        <div class="form-group">
          <label>–®–∏—Ä–∏–Ω–∞ (–º–º):</label>
          <input type="number" id="editWidth" class="form-control">
        </div>
        <div class="form-group">
          <label>–í—ã—Å–æ—Ç–∞ (–º–º):</label>
          <input type="number" id="editHeight" class="form-control">
        </div>
        <div class="form-group">
          <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label>
          <input type="number" id="editQuantity" class="form-control">
        </div>
      </div>
      <div class="edit-modal-buttons">
        <button class="btn btn-secondary" onclick="closeEditModal()">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn btn-primary" id="saveEditBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>
  
  <!-- Include side menu component -->
  <div id="sideMenuContainer"></div>
  
  <!-- Firebase SDK v9 with CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="../js/main.js"></script>
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAGGpNFxQ1bfY4ViSdNM7uOBuk7u_cyxtk",
      authDomain: "ksplus-60132.firebaseapp.com",
      projectId: "ksplus-60132",
      storageBucket: "ksplus-60132.firebasestorage.app",
      messagingSenderId: "1037863910173",
      appId: "1:1037863910173:web:76bebcb7310eaa78a23ff4",
      measurementId: "G-17JRYGSH0S"
    };
    
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    
    // Get Firestore reference
    const db = firebase.firestore();
    
    // Items array to store all measurements
    let items = [];
    let clientId = '';
    let currentEditIndex = -1;
    const ROLL_WIDTH = 1524; // Default roll width in mm

    document.addEventListener('DOMContentLoaded', function() {
      // Load the side menu component
      fetch('../components/sidebar.html')
        .then(response => response.text())
        .then(html => {
          document.getElementById('sideMenuContainer').innerHTML = html;
          
          // Execute any scripts inside the loaded sidebar
          const scripts = document.getElementById('sideMenuContainer').getElementsByTagName('script');
          for (let i = 0; i < scripts.length; i++) {
            eval(scripts[i].innerText);
          }
        });
      
      // Check authentication status
      firebase.auth().onAuthStateChanged(function(user) {
        if (user) {
          // Get client ID from URL
          const urlParams = new URLSearchParams(window.location.search);
          clientId = urlParams.get('clientId');
          
          if (clientId) {
            // Load client data and measurements
            loadClientData(clientId);
            loadMeasurements(clientId);
            
            // Update back link and cutting button
            document.getElementById('backLink').href = `client-details.html?id=${clientId}`;
            document.getElementById('goToCuttingBtn').onclick = function() {
              saveMeasurements().then(() => {
                location.href = `cutting.html?clientId=${clientId}`;
              });
            };
          } else {
            // No client ID, redirect to clients list
            window.location.href = 'clients.html';
          }
        } else {
          // User is signed out, redirect to login
          window.location.href = 'login.html';
        }
      });

      // Add event listeners
      document.getElementById('addItemBtn').addEventListener('click', addItem);
      
      // Quick input with auto-parsing when Enter is pressed
      document.getElementById('quickInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          processQuickInput();
        }
      });
      
      // Save edit button in modal
      document.getElementById('saveEditBtn').addEventListener('click', saveEdit);
    });

    // Load client data
    async function loadClientData(clientId) {
      try {
        const docRef = db.collection('clients').doc(clientId);
        const docSnap = await docRef.get();
        
        if (docSnap.exists) {
          const client = {
            id: docSnap.id,
            ...docSnap.data()
          };
          
          // Display client name
          document.getElementById('clientName').textContent = client.name || '–ö–ª–∏–µ–Ω—Ç';
        }
      } catch (error) {
        console.error("Error loading client data:", error);
      }
    }

    // Load existing measurements
    async function loadMeasurements(clientId) {
      try {
        const measurementsRef = db.collection('clients').doc(clientId).collection('measurements');
        const snapshot = await measurementsRef.orderBy('createdAt').get();
        
        if (!snapshot.empty) {
          items = [];
          snapshot.forEach(doc => {
            items.push({
              id: doc.id,
              ...doc.data()
            });
          });
          
          renderItems();
          updateSummary();
        }
      } catch (error) {
        console.error("Error loading measurements:", error);
      }
    }

    // Save measurements to Firestore
    async function saveMeasurements() {
      try {
        if (!clientId) return;
        
        const batch = db.batch();
        const measurementsRef = db.collection('clients').doc(clientId).collection('measurements');
        
        // Delete existing measurements
        const snapshot = await measurementsRef.get();
        snapshot.forEach(doc => {
          batch.delete(doc.ref);
        });
        
        // Add new measurements
        items.forEach((item, index) => {
          const docRef = measurementsRef.doc();
          batch.set(docRef, {
            width: item.width,
            height: item.height,
            quantity: item.quantity,
            area: item.area,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            order: index
          });
        });
        
        // Update client status if needed
        if (items.length > 0) {
          batch.update(db.collection('clients').doc(clientId), {
            status: '–ó–∞–º–µ—Ä –≤—ã–ø–æ–ª–Ω–µ–Ω',
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
          });
        }
        
        await batch.commit();
        console.log("Measurements saved successfully");
      } catch (error) {
        console.error("Error saving measurements:", error);
      }
    }

    // Add item from manual input
    function addItem() {
      const width = parseInt(document.getElementById('width').value);
      const height = parseInt(document.getElementById('height').value);
      const quantity = parseInt(document.getElementById('quantity').value);
      
      if (width && height && quantity) {
        const area = calculateArea(width, height, quantity);
        items.push({
          width,
          height,
          quantity,
          area
        });
        
        renderItems();
        updateSummary();
        
        // Clear quantity input (but keep width and height for convenience)
        document.getElementById('quantity').value = "1";
      }
    }

    // Process quick input
    function processQuickInput() {
      const text = document.getElementById('quickInput').value.trim();
      const lines = text.split('\n');
      
      let addedCount = 0;
      
      lines.forEach(line => {
        line = line.trim();
        if (line) {
          const parts = line.split(';');
          if (parts.length >= 3) {
            const width = parseInt(parts[0]);
            const height = parseInt(parts[1]);
            const quantity = parseInt(parts[2]);
            
            if (width && height && quantity) {
              const area = calculateArea(width, height, quantity);
              items.push({
                width,
                height,
                quantity,
                area
              });
              addedCount++;
            }
          }
        }
      });
      
      if (addedCount > 0) {
        renderItems();
        updateSummary();
        document.getElementById('quickInput').value = '';
      }
    }

    // Calculate area for an item
    function calculateArea(width, height, quantity) {
      return (width / 1000) * (height / 1000) * quantity;
    }

    // Get shape icon based on dimensions
    function getShapeIcon(width, height) {
      const ratio = width / height;
      
      if (ratio >= 1.5) {
        return '<div class="shape-horizontal"></div>';
      } else if (ratio <= 0.67) {
        return '<div class="shape-vertical"></div>';
      } else {
        return '<div class="shape-square"></div>';
      }
    }

    // Render all items in the list
    function renderItems() {
      const itemsList = document.getElementById('itemsList');
      itemsList.innerHTML = '';
      
      items.forEach((item, index) => {
        const itemCard = document.createElement('div');
        itemCard.className = 'item-card';
        itemCard.innerHTML = `
          <div class="item-shape">${getShapeIcon(item.width, item.height)}</div>
          <div class="item-info">
            <div class="item-dimensions">${item.width}√ó${item.height}</div>
            <div class="item-area">${item.quantity} —à—Ç. = ${item.area.toFixed(2)}–º¬≤</div>
          </div>
          <div class="item-actions">
            <button class="item-action-btn edit-btn" data-index="${index}">‚úè</button>
            <button class="item-action-btn delete-btn" data-index="${index}">‚ùå</button>
          </div>
        `;
        
        itemsList.appendChild(itemCard);
    });
    
    // Add event listeners for edit and delete buttons
    document.querySelectorAll('.edit-btn').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
          const index = parseInt(this.getAttribute('data-index'));
          openEditModal(index);
        });
    });
    
    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
          const index = parseInt(this.getAttribute('data-index'));
          deleteItem(index);
        });
      });
    }

    // Update summary calculations
    function updateSummary() {
      // Calculate total items
      const totalItems = items.reduce((sum, item) => sum + item.quantity, 0);
      
      // Calculate total area
      const totalArea = items.reduce((sum, item) => sum + item.area, 0);
      
      // Simple roll length estimation (more complex calculation would be in the cutting algorithm)
      // This is just a rough estimate based on area and roll width
      const rollLength = totalArea / (ROLL_WIDTH / 1000) * 1.15; // Adding 15% for waste
      const rollArea = rollLength * (ROLL_WIDTH / 1000);
      
      // Update display
      document.getElementById('totalItems').textContent = `‚Ä¢ –î–µ—Ç–∞–ª–µ–π: ${totalItems}`;
      document.getElementById('totalArea').textContent = `‚Ä¢ –û–±—â–∞—è –ø–ª–æ—â–∞–¥—å: ${totalArea.toFixed(2)} –º¬≤`;
      document.getElementById('rollLength').textContent = `‚Ä¢ –†—É–ª–æ–Ω: ${rollLength.toFixed(1)} –º–ø (${rollArea.toFixed(1)} –º¬≤)`;
      
      // Update cutting map
      const utilization = totalArea / rollArea * 100;
      document.getElementById('cuttingMapVisual').style.background = 
        `linear-gradient(to right, #4a6da7 ${utilization.toFixed(0)}%, #f8f9fa ${100-utilization.toFixed(0)}%)`;
      document.getElementById('cuttingMapInfo').textContent = `${utilization.toFixed(0)}% –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ`;
    }

    // Delete item
    function deleteItem(index) {
      if (index >= 0 && index < items.length) {
        items.splice(index, 1);
        renderItems();
        updateSummary();
      }
    }

    // Open edit modal
    function openEditModal(index) {
      if (index >= 0 && index < items.length) {
        currentEditIndex = index;
        const item = items[index];
        
        document.getElementById('editWidth').value = item.width;
        document.getElementById('editHeight').value = item.height;
        document.getElementById('editQuantity').value = item.quantity;
        
        document.getElementById('editModal').style.display = 'flex';
      }
    }

    // Close edit modal
    function closeEditModal() {
      document.getElementById('editModal').style.display = 'none';
      currentEditIndex = -1;
    }

    // Save edited item
    function saveEdit() {
      if (currentEditIndex >= 0 && currentEditIndex < items.length) {
        const width = parseInt(document.getElementById('editWidth').value);
        const height = parseInt(document.getElementById('editHeight').value);
        const quantity = parseInt(document.getElementById('editQuantity').value);
        
        if (width && height && quantity) {
          const area = calculateArea(width, height, quantity);
          
          items[currentEditIndex] = {
            width,
            height,
            quantity,
            area
          };
          
          renderItems();
          updateSummary();
          closeEditModal();
        }
      }
    }

    // Format currency
    function formatCurrency(amount) {
      return new Intl.NumberFormat('ru-RU').format(Math.round(amount)) + " ‚Ç¥";
    }
  </script>
</body>
</html> 